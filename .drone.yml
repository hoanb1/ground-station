kind: pipeline
type: docker
name: default

timeout: 360

platform:
  os: linux
  arch: arm64

trigger:
  branch:
    - main
  event:
    - push
    - pull_request
    - tag
    - custom

clone:
  disable: true

steps:
  - name: clone
    image: plugins/git
    settings:
      depth: 50
      skip_verify: true
      tags: true

  - name: build-and-deploy
    image: docker:cli
    environment:
      DOCKER_HOST: tcp://192.168.60.98:2375
    commands:
      # Determine version
      - |
        if [ -n "$DRONE_TAG" ]; then
          # If this is a tagged build, use the tag
          VERSION=$DRONE_TAG
        else
          # Otherwise use branch-commit format
          GIT_SHA=$(git rev-parse --short HEAD)
          VERSION=${DRONE_BRANCH:-main}-$GIT_SHA
        fi
        echo "Building version: $VERSION"

      # Build the new image for amd64
      - docker build --platform linux/amd64 -t ground-station:$VERSION .

      # Tag the image for Docker Hub
      - docker tag ground-station:$VERSION sgoudelis/ground-station:$VERSION
      - docker tag ground-station:$VERSION sgoudelis/ground-station:latest

      # Stop and remove the existing container if it exists
      - docker rm -f ground-station-prod || true

      # Run the new container with the versioned image
      - docker run -d -p 0.0.0.0:7000:7000 --device=/dev/bus/usb --restart=unless-stopped --privileged --name ground-station-prod -v /media/pool1/volumes/ground-station-data:/app/backend/db sgoudelis/ground-station:$VERSION

      # Check that it's running
      - sleep 5
      - |
        CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' ground-station-prod)
        if [ "$CONTAINER_STATUS" != "running" ]; then
          echo "Container is not running: $CONTAINER_STATUS"
          docker logs ground-station-prod
          exit 1
        fi

      # Display container info and version
      - echo "✅ New container version $VERSION is running on host port 7000"
      - docker ps | grep ground-station-prod

  - name: verify-docker-connection
    image: docker:cli
    environment:
      DOCKER_HOST: tcp://192.168.60.98:2375
    commands:
      - docker info
      - echo "Docker connection verified"

  - name: docker-auth
    image: docker:cli
    environment:
      DOCKER_HOST: tcp://192.168.60.98:2375
      DOCKER_USERNAME:
        from_secret: docker_username
      DOCKER_PASSWORD:
        from_secret: docker_password
    commands:
      - echo "Attempting Docker Hub authentication..."
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - echo "✅ Docker Hub authentication successful"

  - name: build-and-push-manual
    image: docker:cli
    environment:
      DOCKER_HOST: tcp://192.168.60.98:2375
    commands:
      # Determine version
      - |
        if [ -n "$DRONE_TAG" ]; then
          VERSION=$DRONE_TAG
        else
          VERSION=${DRONE_BRANCH:-main}-${DRONE_COMMIT_SHA:0:7}
        fi
        echo "Building version $VERSION"

      # Build and push AMD64 first (faster)
      - docker buildx create --use --name builder
      - docker buildx inspect --bootstrap
      - |
        docker buildx build \
          --platform linux/amd64 \
          -t sgoudelis/ground-station:$VERSION-amd64 \
          --push \
          .

      # Then build and push ARM64
      - |
        docker buildx build \
          --platform linux/arm64 \
          -t sgoudelis/ground-station:$VERSION-arm64 \
          --push \
          .

      # Create and push manifest
      - |
        docker manifest create sgoudelis/ground-station:$VERSION \
          sgoudelis/ground-station:$VERSION-amd64 \
          sgoudelis/ground-station:$VERSION-arm64
      - docker manifest push sgoudelis/ground-station:$VERSION
      - |
        docker manifest create sgoudelis/ground-station:latest \
          sgoudelis/ground-station:$VERSION-amd64 \
          sgoudelis/ground-station:$VERSION-arm64
      - docker manifest push sgoudelis/ground-station:latest

volumes:
  - name: dockersock
    host:
      path: /var/run/docker.sock