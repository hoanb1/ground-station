kind: pipeline
type: docker
name: default

platform:
  os: linux
  arch: arm64

trigger:
  branch:
    - main
  event:
    - push
    - pull_request
    - custom

clone:
  disable: true

steps:
  - name: clone
    image: plugins/git
    settings:
      depth: 50
      skip_verify: true

  - name: deploy
    image: docker:cli
    environment:
      DOCKER_HOST: tcp://192.168.60.98:2375
    commands:
      # Build the new image directly on the remote host
      - docker build -t ground-station:latest .

      # Stop and remove existing container if it exists
      - docker rm -f ground-station-prod || true

      # Run the new container
      - docker run -d -p 0.0.0.0:7000:7000 --restart=unless-stopped  --privileged -v /dev/bus/usb:/dev/bus/usb --name ground-station-prod -v /media/pool1/volumes/ground-station-data:/app/backend/db ground-station:latest

      # Check that it's running
      - sleep 5
      - |
        CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' ground-station-prod)
        if [ "$CONTAINER_STATUS" != "running" ]; then
          echo "Container is not running: $CONTAINER_STATUS"
          docker logs ground-station-prod
          exit 1
        fi

      # Display container info
      - echo "âœ… New container is running on host port 7000"
      - docker ps | grep ground-station-prod

volumes:
  - name: dockersock
    host:
      path: /var/run/docker.sock