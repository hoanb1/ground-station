# Scheduled Observations System

## Overview

The Scheduled Observations system allows users to define automated satellite observation sessions with support for:
- Multiple SDRs and transmitter configurations
- Decoders (AFSK, GMSK, SSTV, etc.)
- Audio and IQ recording
- Rotator tracking and rig Doppler correction
- Flexible task composition within the same SDR spectrum

## Data Structure

### Observation Object

Each scheduled observation is defined by the following structure:

```javascript
{
  // Identification
  id: string,                    // UUID generated by backend
  name: string,                  // User-friendly name (e.g., "ISS APRS Evening Pass")
  enabled: boolean,              // Whether this observation is active
  
  // Satellite Configuration
  satellite: {
    norad_id: string,            // NORAD catalog ID (e.g., "25544" for ISS)
    name: string                 // Satellite name (e.g., "ISS")
  },
  
  // Pass Configuration (null for geostationary satellites)
  pass: {
    event_start: string,         // ISO timestamp (e.g., "2025-01-15T20:30:00Z")
    event_end: string,           // ISO timestamp
    peak_altitude: number,       // Degrees above horizon
    azimuth_at_start: number,    // Degrees (0-360)
    azimuth_at_peak: number,     // Degrees (0-360)
    azimuth_at_end: number       // Degrees (0-360)
  } | null,
  
  // SDR Configuration
  sdr: {
    id: string,                  // SDR device ID from hardware configuration
    name: string                 // SDR device name
  },
  
  // Transmitter/Frequency Configuration
  transmitter: {
    id: string | null,           // Optional transmitter ID from satellite database
    frequency: number,           // Center frequency in Hz (e.g., 145800000)
    mode: string,                // Modulation mode (e.g., "FM", "USB", "CW")
    bandwidth: number            // Bandwidth in Hz
  },
  
  // Tasks - Array of recording/decoding tasks to perform
  tasks: [
    // Decoder task
    {
      type: 'decoder',
      config: {
        decoder_type: string,    // 'afsk', 'gmsk', 'fsk', 'sstv', 'aprs', 'morse'
        vfo: number | null       // VFO marker number, or null for main signal
      }
    },
    
    // Audio recording task
    {
      type: 'audio_recording',
      config: {
        format: string,          // 'wav', 'mp3', 'flac'
        vfo: number | null       // VFO marker number, or null for main signal
      }
    },
    
    // IQ recording task
    {
      type: 'iq_recording',
      config: {
        sample_rate: number,     // Sample rate in Hz (e.g., 250000)
        format: string           // 'complex_int16', 'complex_float32'
      }
    }
  ],
  
  // Optional Hardware Control
  rotator: {
    id: string | null,           // Rotator ID from hardware config, or null
    tracking_enabled: boolean    // Whether to track satellite with rotator
  },
  
  rig: {
    id: string | null,           // Rig ID from hardware config, or null
    doppler_correction: boolean, // Whether to apply Doppler correction
    vfo: string                  // 'VFO_A' or 'VFO_B'
  },
  
  // Metadata
  created_at: string,            // ISO timestamp
  updated_at: string,            // ISO timestamp
  status: string                 // 'scheduled' | 'running' | 'completed' | 'failed' | 'cancelled'
}
```

## Backend Integration

### Socket Events to Implement

The backend should implement the following socket.io event handlers:

#### Data Requests
- `get-scheduled-observations` - Fetch all scheduled observations
- Returns: `{ success: boolean, data: Observation[] }`

#### Data Submissions
- `create-scheduled-observation` - Create a new observation
  - Payload: `Observation` (without id, status, created_at)
  - Returns: `{ success: boolean, data: Observation }`

- `update-scheduled-observation` - Update an existing observation
  - Payload: `Observation` (with id)
  - Returns: `{ success: boolean, data: Observation }`

- `delete-scheduled-observations` - Delete observation(s)
  - Payload: `string[]` (array of observation IDs)
  - Returns: `{ success: boolean }`

- `toggle-observation-enabled` - Enable/disable observation
  - Payload: `{ id: string, enabled: boolean }`
  - Returns: `{ success: boolean, data: { id: string, enabled: boolean } }`

- `cancel-observation` - Cancel a running observation
  - Payload: `string` (observation ID)
  - Returns: `{ success: boolean, data: { id: string } }`

#### Real-time Updates
- `observation-status-update` - Emitted by backend when observation status changes
  - Payload: `{ id: string, status: string }`

## Example Use Cases

### 1. Simple APRS Decoding
```javascript
{
  name: "ISS APRS Morning Pass",
  enabled: true,
  satellite: { norad_id: "25544", name: "ISS" },
  pass: { event_start: "2025-01-15T08:30:00Z", event_end: "2025-01-15T08:40:00Z", ... },
  sdr: { id: "rtlsdr_01", name: "RTL-SDR #1" },
  transmitter: { frequency: 145800000, mode: "FM", bandwidth: 12500 },
  tasks: [
    { type: 'decoder', config: { decoder_type: 'aprs', vfo: null } }
  ],
  rotator: { id: "rotator_01", tracking_enabled: true },
  rig: { id: null, doppler_correction: false, vfo: 'VFO_A' }
}
```

### 2. Multi-Signal Recording (Main + VFO)
```javascript
{
  name: "NOAA Weather Satellite Multi-Channel",
  enabled: true,
  satellite: { norad_id: "33591", name: "NOAA 19" },
  pass: { event_start: "2025-01-15T14:20:00Z", event_end: "2025-01-15T14:35:00Z", ... },
  sdr: { id: "sdrplay_01", name: "SDRPlay RSPdx" },
  transmitter: { frequency: 137100000, mode: "APT", bandwidth: 40000 },
  tasks: [
    // Record IQ for the main APT signal
    { type: 'iq_recording', config: { sample_rate: 250000, format: 'complex_int16' } },
    // Decode audio from VFO marker #1
    { type: 'audio_recording', config: { format: 'wav', vfo: 1 } },
    // Also decode a digital signal on VFO marker #2
    { type: 'decoder', config: { decoder_type: 'gmsk', vfo: 2 } }
  ],
  rotator: { id: "rotator_01", tracking_enabled: true },
  rig: { id: "ic9700", doppler_correction: true, vfo: 'VFO_A' }
}
```

### 3. Geostationary Satellite (Continuous)
```javascript
{
  name: "Es'hail-2 SSTV Monitor",
  enabled: true,
  satellite: { norad_id: "43700", name: "Es'hail-2" },
  pass: null,  // Null indicates always visible (geostationary)
  sdr: { id: "sdrplay_02", name: "SDRPlay RSP1A" },
  transmitter: { frequency: 2400025000, mode: "USB", bandwidth: 3000 },
  tasks: [
    { type: 'decoder', config: { decoder_type: 'sstv', vfo: null } },
    { type: 'audio_recording', config: { format: 'mp3', vfo: null } }
  ],
  rotator: { id: null, tracking_enabled: false },  // No rotator needed
  rig: { id: null, doppler_correction: false, vfo: 'VFO_A' }
}
```

## Implementation Notes

1. **Task Execution**: All tasks in the `tasks` array should run concurrently during the observation period
2. **VFO Markers**: Tasks can reference VFO markers for processing specific signals within the SDR bandwidth
3. **Hardware Control**: Rotator tracking and rig Doppler correction are optional and independent
4. **Status Lifecycle**: scheduled → running → completed/failed/cancelled
5. **Real-time Updates**: Backend should emit `observation-status-update` events for status changes

## UI Components

- `main-layout.jsx` - Main page container with real-time updates
- `observations-table.jsx` - DataGrid showing all scheduled observations
- `observation-form-dialog.jsx` - Dialog for creating/editing observations
- `scheduler-slice.jsx` - Redux state management
